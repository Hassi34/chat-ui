<section class="chat" aria-live="polite">
  <div class="chat__container" [class.chat__container--has-messages]="messages().length > 0">
    @if (messages().length === 0) {
      <section class="chat__suggestions" aria-label="Suggested prompts">
        <div class="chat__hero">
          <div class="chat__hero-banner" aria-hidden="true">
            <span class="chat__hero-face">
              <span class="chat__hero-eye chat__hero-eye--left"></span>
              <span class="chat__hero-eye chat__hero-eye--right"></span>
              <span class="chat__hero-smile"></span>
              <span class="chat__hero-blush chat__hero-blush--left"></span>
              <span class="chat__hero-blush chat__hero-blush--right"></span>
            </span>
            <span class="chat__hero-hand"></span>
          </div>
          <p class="chat__hero-greeting" aria-live="polite">
            <span class="chat__hero-greeting-text">
              {{ animatedGreeting() }}
              <span class="chat__hero-greeting-cursor" aria-hidden="true"></span>
            </span>
          </p>
        </div>
        <h2>Ask me anything to get started</h2>
        <p>Pick a prompt or craft your own message below to open a new conversation.</p>
        <div class="chat__suggestions-grid">
          @for (prompt of samplePrompts; track prompt.text) {
            <button
              type="button"
              class="chat__suggestion"
              (click)="handleSamplePrompt(prompt.text)"
              [disabled]="isSending()"
            >
              <mat-icon aria-hidden="true">{{ prompt.icon }}</mat-icon>
              <span>{{ prompt.text }}</span>
            </button>
          }
        </div>
      </section>
    }

    <div class="chat__messages" #messageViewport>
      @for (message of messages(); track message.id) {
        <article
          class="chat-message animation"
          [class.chat-message--user]="message.role === 'user'"
          [class.chat-message--assistant]="message.role === 'assistant'"
          [class.chat-message--pending]="message.pending"
          [class.chat-message--error]="message.error"
        >
          <div class="chat-message__body">
            <div class="chat-message__content">
              @if (message.pending) {
                <span class="chat-message__loader" aria-hidden="true">
                  <span></span>
                  <span></span>
                  <span></span>
                </span>
              } @else {
                {{ message.content }}
              }
            </div>

            @if (message.role === 'assistant' && !message.pending) {
              <div class="chat-message__footer">
                <div class="chat-message__actions" role="group" aria-label="Rate this reply">
                  <button
                    mat-icon-button
                    type="button"
                    aria-label="Mark reply as helpful"
                    [class.chat-message__action--active]="message.feedback === 'up'"
                    (click)="handleFeedback(message.id, 'up')"
                    [attr.aria-pressed]="message.feedback === 'up' ? 'true' : 'false'"
                  >
                    <mat-icon aria-hidden="true">thumb_up</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    type="button"
                    aria-label="Mark reply as not helpful"
                    [class.chat-message__action--active]="message.feedback === 'down'"
                    (click)="handleFeedback(message.id, 'down')"
                    [attr.aria-pressed]="message.feedback === 'down' ? 'true' : 'false'"
                  >
                    <mat-icon aria-hidden="true">thumb_down</mat-icon>
                  </button>
                </div>

                @if (message.feedback === 'down') {
                  <div class="chat-feedback" aria-live="polite">
                    @if (!message.feedbackSubmitted) {
                      <label class="chat-feedback__label" [attr.for]="'feedback-' + message.id">
                        Share why this wasn't helpful <span aria-hidden="true">(optional)</span>
                      </label>
                      <textarea
                        [id]="'feedback-' + message.id"
                        class="chat-feedback__input"
                        rows="3"
                        [ngModel]="message.feedbackDraft ?? ''"
                        (ngModelChange)="handleFeedbackCommentChange(message.id, $event)"
                        placeholder="Let us know what went wrong"
                      ></textarea>
                      <div class="chat-feedback__actions">
                        <button mat-flat-button color="primary" type="button" (click)="handleFeedbackSubmit(message.id)">
                          Submit feedback
                        </button>
                        <button mat-button type="button" (click)="handleFeedbackCancel(message.id)">
                          Cancel
                        </button>
                      </div>
                    } @else {
                      <div class="chat-feedback__confirmation">
                        <mat-icon aria-hidden="true">check_circle</mat-icon>
                        <span>Thanks for the feedback!</span>
                        <button mat-button type="button" (click)="handleFeedbackEdit(message.id)">
                          Update
                        </button>
                      </div>
                      @if (message.feedbackComment) {
                        <p class="chat-feedback__note">“{{ message.feedbackComment }}”</p>
                      }
                    }
                  </div>
                }
              </div>
            }
          </div>

          <footer class="chat-message__meta">
            <span class="chat-message__role">{{ message.role === 'user' ? 'You' : 'Assistant' }}</span>
            <div class="chat-message__meta-actions">
              <span class="chat-message__timestamp">{{ message.createdAt | date: 'shortTime' }}</span>
              <button
                mat-icon-button
                type="button"
                class="chat-message__copy"
                aria-label="Copy message"
                (click)="handleCopy(message.content)"
              >
                <mat-icon aria-hidden="true">content_copy</mat-icon>
              </button>
            </div>
          </footer>
        </article>
      }
    </div>

    <footer class="chat__composer">
      <button
        type="button"
        class="chat__new-chat"
        (click)="resetConversation()"
        [disabled]="isSending() || messages().length === 0"
        aria-label="Start a new chat"
      >
        <span class="chat__new-chat-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M12 2C17.5228 2 22 6.47715 22 12C22 12.2628 21.9899 12.5232 21.97 12.7809C21.5319 12.3658 21.0361 12.0111 20.4958 11.73C20.3532 7.16054 16.6041 3.5 12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.04305 20.0852 10.3592 20.4531 11.73 20.4958C12.0111 21.0361 12.3658 21.5319 12.7809 21.97C12.5232 21.9899 12.2628 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2ZM23 17.5C23 14.4624 20.5376 12 17.5 12C14.4624 12 12 14.4624 12 17.5C12 20.5376 14.4624 23 17.5 23C20.5376 23 23 20.5376 23 17.5ZM18.0006 18L18.0011 20.5035C18.0011 20.7797 17.7773 21.0035 17.5011 21.0035C17.225 21.0035 17.0011 20.7797 17.0011 20.5035L17.0006 18H14.4956C14.2197 18 13.9961 17.7762 13.9961 17.5C13.9961 17.2239 14.2197 17 14.4956 17H17.0005L17 14.4993C17 14.2231 17.2239 13.9993 17.5 13.9993C17.7761 13.9993 18 14.2231 18 14.4993L18.0005 17H20.4966C20.7725 17 20.9961 17.2239 20.9961 17.5C20.9961 17.7762 20.7725 18 20.4966 18H18.0006Z"
            ></path>
          </svg>
        </span>
        <span class="chat__new-chat-label">New chat</span>
      </button>

      <app-chat-input
        class="chat__input"
        [disabled]="isSending()"
        (sendMessage)="handleSend($event)"
      ></app-chat-input>
    </footer>
  </div>
</section>
